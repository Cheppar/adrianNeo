<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>MVP Adrian Neo</title>
        <link rel="icon" href="images/head-image.png">
        <link rel="stylesheet" href="src/leaflet.css">
        <!-- <link rel="stylesheet" href="https://nakuplan.com/miami/src/fonts/leaflet.css"> -->
        <link rel="stylesheet" href="src/css/bootstrap.css">
        <link rel="stylesheet" href="src/plugins/L.Control.MousePosition.css">
        <link rel="stylesheet" href="src/plugins/L.Control.Sidebar.css">
        <link rel="stylesheet" href="src/plugins/Leaflet.PolylineMeasure.css">
        <link rel="stylesheet" href="src/plugins/easy-button.css">
        <link rel="stylesheet" href="src/plugins/leaflet-styleeditor/css/Leaflet.StyleEditor.css">
        <link rel="stylesheet" href="src/css/font-awesome.min.css">
        <link rel="stylesheet" href="src/plugins/leaflet.awesome-markers.css">
        <link rel="stylesheet" href="src/plugins/leaflet-mapkey/MapkeyIcons.css">
        <link rel="stylesheet" href="src/plugins/leaflet-mapkey/L.Icon.Mapkey.css">
        <link rel="stylesheet" href="src/plugins/MarkerCluster.css">
        <link rel="stylesheet" href="src/plugins/MarkerCluster.Default.css">
        <link rel="stylesheet" href="src/jquery-ui.min.css">
        <link rel="stylesheet" href="src/dist/searchbox.min.css" />

        <!-- Circl ci  -->
        <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,700,800&display=swap" rel="stylesheet">
        <link href="src/assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <link href="src/assets/plugins/font-awesome/css/all.min.css" rel="stylesheet">
        <link href="src/assets/plugins/perfectscroll/perfect-scrollbar.css" rel="stylesheet">
        <!-- <link href="src/assets/plugins/apexcharts/apexcharts.css" rel="stylesheet"> -->

      
        <!-- Circl ci Theme Styles -->
        <link href="src/assets/css/main.min.css" rel="stylesheet">
        <link href="src/assets/css/dark-theme.css" rel="stylesheet">
        <link href="src/assets/css/custom.css" rel="stylesheet">



        <!-- <script src="https://cdn.tailwindcss.com"></script> -->
        <script src="src/leaflet-src.js"></script>
        <script src="src/jquery-3.2.0.min.js"></script>
        <script src="src/plugins/L.Control.MousePosition.js"></script>
        <script src="src/plugins/L.Control.Sidebar.js"></script>
        <script src="src/plugins/Leaflet.PolylineMeasure.js"></script>
        <script src="src/plugins/easy-button.js"></script>
        <script src="src/plugins/leaflet-providers.js"></script>
        <script src="src/plugins/leaflet-styleeditor/javascript/Leaflet.StyleEditor.js"></script>
        <script src="src/plugins/leaflet-styleeditor/javascript/Leaflet.StyleForms.js"></script>
        <script src="src/plugins/leaflet.ajax.min.js"></script>
        <script src="src/plugins/leaflet.sprite.js"></script>
        <script src="src/plugins/leaflet.awesome-markers.min.js"></script>
        <script src="src/plugins/leaflet-mapkey/L.Icon.Mapkey.js"></script>
        <script src="src/plugins/leaflet.markercluster.js"></script>
        <script src="src/jquery-ui.min.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnEl2RxBw5w0u4WZsuxuPXe0BryUtPQrk" async defer></script>
        <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@latest/dist/Leaflet.GoogleMutant.js"></script>
        <script src="src/dist/leaflet.customsearchbox.min.js"></script>
        <script src="https://www.paypal.com/sdk/js?client-id=sb&enable-funding=venmo&currency=USD" data-sdk-integration-source="button-factory"></script>

        <!-- Circl ci JS -->
        <script src="src/assets/plugins/jquery/jquery-3.4.1.min.js"></script>
        <script src="https://unpkg.com/@popperjs/core@2"></script>
        <script src="src/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
        <script src="https://unpkg.com/feather-icons"></script>
        <script src="src/assets/plugins/perfectscroll/perfect-scrollbar.min.js"></script>
        <!-- <script src="src/assets/plugins/apexcharts/apexcharts.min.js"></script> -->
        <script src="src/assets/js/main.min.js"></script>
        <script src="src/assets/js/pages/dashboard.js"></script>

        <script src="src/domtraverse.js"></script>

<!--    ***************  Begin Leaflet.Draw-->

        <script src="src/plugins/leaflet-draw/Leaflet.draw.js"></script>
        <script src="src/plugins/leaflet-draw/Leaflet.Draw.Event.js"></script>
        <link rel="stylesheet" href="src/plugins/leaflet-draw/leaflet.draw.css"/>

        <script src="src/plugins/leaflet-draw/Toolbar.js"></script>
        <script src="src/plugins/leaflet-draw/Tooltip.js"></script>

        <script src="src/plugins/leaflet-draw/ext/GeometryUtil.js"></script>
        <script src="src/plugins/leaflet-draw/ext/LatLngUtil.js"></script>
        <script src="src/plugins/leaflet-draw/ext/LineUtil.Intersect.js"></script>
        <script src="src/plugins/leaflet-draw/ext/Polygon.Intersect.js"></script>
        <script src="src/plugins/leaflet-draw/ext/Polyline.Intersect.js"></script>
        <script src="src/plugins/leaflet-draw/ext/TouchEvents.js"></script>

        <script src="src/plugins/leaflet-draw/draw/DrawToolbar.js"></script>
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Feature.js"></script>
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.SimpleShape.js"></script>
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Polyline.js"></script>
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Circle.js"></script>
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Marker.js"></script>
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Polygon.js"></script>
        <script src="src/plugins/leaflet-draw/draw/handler/Draw.Rectangle.js"></script>


        <script src="src/plugins/leaflet-draw/edit/EditToolbar.js"></script>
        <script src="src/plugins/leaflet-draw/edit/handler/EditToolbar.Edit.js"></script>
        <script src="src/plugins/leaflet-draw/edit/handler/EditToolbar.Delete.js"></script>

        <script src="src/plugins/leaflet-draw/Control.Draw.js"></script>

        <script src="src/plugins/leaflet-draw/edit/handler/Edit.Poly.js"></script>
        <script src="src/plugins/leaflet-draw/edit/handler/Edit.SimpleShape.js"></script>
        <script src="src/plugins/leaflet-draw/edit/handler/Edit.Circle.js"></script>
        <script src="src/plugins/leaflet-draw/edit/handler/Edit.Rectangle.js"></script>
        <script src="src/plugins/leaflet-draw/edit/handler/Edit.Marker.js"></script>

<!--    **************  End of Lealet Draw-->

    </head>
    <body>

        
        
        <div id="side-bar" class="col-md-2   scroll ">

            <div class="ps ps--active-y"> 
            

        <div class="card folder" style="margin-top: 60px;">
            <div class="card-body">
                <div class="card-body">
                    <h3 class="card-title">My Wallets</h3>
                    <div class="transactions-list">
                      <div class="tr-item">
                        <div class="tr-company-name">
                          <div class="tr-icon tr-card-icon tr-card-bg-primary text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-thumbs-up"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                          </div>
                          <div class="tr-text">
                            <h4>Facebook</h4>
                            <!-- <p>02 March</p> -->
                          </div>
                        </div>
                        <div class="tr-rate">
                          <p><span class="text-success">ETH Acc</span></p>
                        </div>
                      </div>
                    </div>     
                </div>
               
            </div>
        </div>   

        <div class="card folder">
            <div class="card-body">
                <div class="folder-info">
                    <h3 class="card-title">Parcel Data</h3>
                    <div class="card-body c-b-parcel " id='xxb'>
                        <h5 class="card-title parcel" id="parcel">Parcel Info</h5>
                        <p class="card-text">  View parcel details, current owner and price. All transactions are smart contract. </p>
                       
                        <button type="button" class="btn btn-primary" id="owner">
                            xxxxx <span class="badge bg-success">4</span>
                          </button>
                
                        <button class="btn btn-block btn-info m-t-md" id="ETH">Claim Parcel</button> 
                      </div>
                </div>
            </div>
        </div>
        </div>
        </div>

        


        <div id="mapdiv" class="col-md-12"></div> 
        <div id="dlgModal" class="modal">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content ">
                <div class="modal-header ">     
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="float: right;"></button>
                
                <div id="paypal-button-container"></div>
                    <div class="card-body paps" action="./index.php" method="POST">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="float: right;"></button>
                        <h5 class="card-title">Pay with Mpesa</h5>
                        <p class="card-description">Mpesa users in Kenya <code>&lt;Kenya&gt;</code> and <code>&lt;Uganda&gt;</code>.</p>
                        <div class="mb-3">
                            <label for="formGroupExampleInput" class="form-label">Amount</label>
                            <input type="text" class="form-control" id="formGroupExampleInput" name="amount" placeholder="Enter Amount">         
                        </div>
                        <div class="mb-3">
                            <label for="formGroupExampleInput2" class="form-label">Phone Number</label>
                            <input type="text" class="form-control" name="phone" placeholder="0700-000-000">
                        </div>

                          <button type="submit" name="submit" value="submit" class="btn btn-primary m-b-xs">Purchase Land</button>
                    </div>


                  </div>
                  <div class="modal-body">
                     To view owner please login or register your account. Powered by Metamask.
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-warning m-b-xs">LOGIN</button>
                    <!-- //<button type="button" class="btn btn-warning m-b-xs">Warning</button> -->
                  </div>
                </div>
                
              </div>
        </div>
    

        </div>
        <script>
            var mymap;
            var lyrOSM;
            var lyrWatercolor;
            var lyrTopo;
            var lyrImagery;
            var lyrOutdoors;
            var lyrEagleNests;
            var lyrRaptorNests;
            var lyrClientLines;
            var lyrBUOWL;
            var lyrGBH;
            var lyrGith;
            var lyrBuildings;
            var lyrLandUse;
            var lyrSearch;
            var lyrMarkerCluster;
            var mrkCurrentLocation;
            var fgpDrawnItems;
            var ctlAttribute;
            var ctlScale;
            var ctlMouseposition;
            var ctlMeasure;
            var ctlEasybutton;
            var ctlSidebar;
            var ctlRsidebar
            var ctlLayers;
            var ctlDraw;
            var ctlStyle;
            var ctlLocate;
            var objBasemaps;
            var objOverlays;
            var arLayersIDs  = [];
            var arProjectIDs = [];
            var arHabitatIDs = [];
            var arEagleIDs   = [];
            var arRaptorIDs  = [];

            $(document).ready(function(){
            // $("#dlgModal").show();

            //  ********* Map Initialization ****************

                mymap = L.map('mapdiv', 
                    {center: [39.82759, -105.04232],
                    zoom:17,
                    minZoom:1, 
                    attributionControl:false});

                 ctlAttribute = L.control.attribution().addTo(mymap);
                ctlAttribute.addAttribution('OSM');
                ctlAttribute.addAttribution('&copy; <a href="http://www.com">AltoChange Consulting</a>');

                mymap.zoomControl.setPosition('bottomright');

                ctlSidebar = L.control.sidebar('side-bar').addTo(mymap);   

                ctlLocate = L.easyButton('glyphicon-screenshot',function(){
                   mymap.locate();
                }).setPosition('topright').addTo(mymap);

                ctlScale = L.control.scale({position:'bottomleft', metric:false, maxWidth:200}).addTo(mymap);

                ctlMouseposition = L.control.mousePosition().addTo(mymap);

                //   *********** Layer Initialization **********

                lyrOSM = L.tileLayer.provider('OpenStreetMap.Mapnik');
                lyrTopo = L.tileLayer.provider('OpenTopoMap');
                lyrImagery = L.tileLayer.provider('Esri.WorldImagery');
                lyrOutdoors = L.tileLayer.provider('Thunderforest.Outdoors');
                lyrWatercolor = L.tileLayer.provider('Stamen.Watercolor');
                var googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']});
                mymap.addLayer(googleStreets);

                fgpDrawnItems = new L.FeatureGroup();
                fgpDrawnItems.addTo(mymap);

                mymap.on('zoomend', function(e) {
                    if (mymap.getZoom() <= 15){
                         
                    }else{

                    }
                    if(mymap.getZoom() >= 16){
                          mymap.addLayer(lyrLandUse);
                       

                    }else{
                       
                    }
                });
 
                lyrLandUse = L.geoJSON.ajax('data/label_grid.geojson', { 
                    style: styleLanduse, 
                    onEachFeature: processLanduse, 
                }).addTo(mymap);

                lyrLandUse.on('data:loaded', function(){
                    arLayersIDs.sort(function(a,b){return a-b});
                    $("#txtFindPlot").autocomplete({
                        source:arLayersIDs
                    });
                });

            //<!------- setup layer control ----------->//

                objBasemaps = {
                    "Open Street Maps": lyrOSM,
                    "Topo Map":lyrTopo,
                    "Imagery":lyrImagery

                };

                objOverlays = {
                    "Land Parcel":lyrLandUse,
                };

                ctlLayers = L.control.layers(objBasemaps, objOverlays).addTo(mymap);

                // **********  Setup Draw Control ****************

                ctlDraw = new L.Control.Draw({
                    position:'bottomright',
                    draw:{
                        circle:false,
                        rectangle:false,
                    },
                    edit:{
                        featureGroup:fgpDrawnItems
                    }
                });

                mymap.on('draw:created', function(e){
                    fgpDrawnItems.addLayer(e.layer);
                });

                // ************ Location Events **************

                mymap.on('locationfound', function(e) {
                    console.log(e);
                    if (mrkCurrentLocation) {
                        mrkCurrentLocation.remove();
                    }
                    mrkCurrentLocation = L.circle(e.latlng, {radius:e.accuracy/2}).addTo(mymap);
                    mymap.setView(e.latlng, 14);
                });

                mymap.on('locationerror', function(e) {
                    console.log(e);
                    alert("Location was not found");
                })

            });

            //********** STYLING MAI MAHIU POLYGONS **********//
            function styleDocs(json){
                var att = json.properties;
                switch(att.status){
                    case 'Documented':
                        return {color: 'orange', fillColor:'orange'};
                        break;

                    case 'Not Documented':
                        return {color: 'black'};
                        break;
                }
            }

                function filterPlots(json){
                    var att = json.properties;
                    var optFilter = $("input[name=fltPlots]:checked").val();
                    if(optFilter=='ALL'){
                        return true;
                    }else{
                        return (att.status==optFilter);
                    }
                }

               $(document).ready(function () {
                    control._searchfunctionCallBack = function (searchkeywords)
                    {   
                    function returnPlotByID(id){
                        var arLayers = lyrLandUse.getLayers();
                            for(i=0; i<arLayers.length-1;i++){
                                var featureID = arLayers[i].feature.properties.OBJECTID;
                                    if(featureID == id){
                                        return arLayers[i];
                                        }
                                    }
                            return false;
                }

                //*** find plot query ***//
                $("#searchbox-searchbutton").click(function(){
                    var id = $("#searchboxinput").val();
                    var lyr = returnPlotByID (id);
                    var att = lyr.feature.properties;
                     ctlSidebar.show();
                      
                    if (lyr){
                        if(lyrSearch){
                            lyrSearch.remove();    
                        }

                    ctlSidebar.setContent("<h2 class='text-center real'>Parcel Information </h2><table><tr> <td><h6> Parcel</h6><td> <td>"+att.i+"<td></tr> <tr><td><h6>Land Use</h6><td> <td>"+att.LU+"<td></tr> <tr><td><h6>Plinth Area</h6><td> <td>"+att.Shape__Are+"<td></tr></table>");
                    lyrSearch = L.geoJSON(lyr.toGeoJSON(),
                    {style:{color:'green',
                     weight:10, 
                     opacity:0.5}}).addTo(mymap);
                    mymap.fitBounds(lyr.getBounds().pad(1));
                    }else{
                        $("#divPlotError").html("***Plot Not Found ***");
                    }
                }); 
                }
                mymap.addControl(control);
    });


            function processGith (json, lyr){
            var att = json.properties;
                lyr.bindTooltip("<h4>Plot ID: "+att.Plot_Numbe+"</h4>Status:"+att.Status+"<br> Land Use: "+att.LandUse+"<br> Plot Size in HA: "+att.AREA1 );
                arLayersIDs.push(att.PLOT_NUMBE.toString());
            }


                $("#txtFindPlot").on('keyup paste', function(){
                    var id = $("#txtFindPlot").val();
                    testPlotTxtID(id);
                });


                function styleLanduse(json){
                var att = json.properties;
                switch(att.owner){

                    case 'available':
                        return {color:'black' , weight:0.5, fillColor:'grey', fillOpacity:'0.5'};
                        break;

                    case 'taken':
                        return {color:'orange', weight:1, fillColor:'red', fillOpacity:0.5};
                        break;
                }
            }

                function processLanduse (json, lyr){
                var att = json.properties; 
            
                lyr.on('click', function (e){
                    lyr.bindPopup("<button type='submit' class='btn btn-primary'>"+att.id+"</button>").openPopup().addTo(mymap); 
                    ctlSidebar.show();
                    $('.c-b-parcel').show();

                    var parcelNum = document.getElementById('parcel');
                    parcelNum.textContent = ""+att.id+"";


                    $('#owner').show();
                    var ownerInfo = document.getElementById('owner');
                    ownerInfo.textContent = ""+att.owner+"";

                   
                    if(att.owner === 'taken'){
                    $('#ETH').hide();
                    }else{
                        $('#ETH').show(); 
                        $('#owner').hide();
                    }
                    
                    if (lyr){
                        if(lyrSearch){
                            lyrSearch.remove();
                        }

                    lyrSearch = L.geoJSON(lyr.toGeoJSON(),{style:{color:'green ', weight:10, opacity:0.5}}).addTo(mymap);
                    mymap.fitBounds(lyr.getBounds().pad(1));
                    }
                });
                }

                var markerDefault = {
                    color: 'white',
                    fillColor: 'black',
                    fillOpacity: '0.2',
                    opacity: 1,
                    weight: 1,
                    };

                    var markerHighlight = {
                        weight: 0,
                        opacity: 1,
                        color: 'yellow',
                        fillColor: 'blue',
                        fillOpacity: '0.5'

                    
                    };

                function highlightDot(e) {
                        var lyr = e.target;
                        lyr.setStyle(markerHighlight);
                    };

                    function resetDotHighlight(e) {
                        var lyr = e.target;
                        lyr.setStyle(markerDefault);
                    };
 
                function styleVerified(json){
                    var att = json.properties;
                    switch (att.Status){
                        case 'Documented':
                        return {color:'black', fillColor:'green'};
                        break;

                        case 'Not Document':
                        return {color:'maroon'};
                        break;

                    }
                }

                $("input[name=fltPlots]").click(function(){
                    arLayersIDs = [];
                    lyrGith.refresh();
                });





            //  *********  jQuery Event Handlers  ************

            $("#btnLocate").click(function(){
                mymap.locate();
                $(".para").show();
                $(".paps").hide();
                setTimeout(function() {$('#dlgModal').hide();}, 4000);
            });

            $("#paypal").click(function(){
                console.log('green');
                $("#dlgModal").show();
                $(".para").hide();
                initPayPalButton();
                $("#paypal").attr('disabled', 'disabled');
            });

           $(document).keyup(function(e) {
            if (e.keyCode == 27) { // escape key maps to keycode `27`
                ctlSidebar.hide();
                }
            });

            $("#ETH").click(function(){
                $("#dlgModal").show();
                loginWithMetamask();
            });

            $("#mpesa").click(function(){
                $("#dlgModal").show();
                $(".paps").show();
                $(".para").hide();
            });

            $(".btn-close").click(function(){
                $("#dlgModal").hide();
            });

       

            // mymap.on('keypress', function (e) {
            //     if (e.original.Event.key == "l") {
            //         mymap.locate();
            //     }
            // });

            // mymap.on('locationfound', function (e) {
            //     console.log(e);
            //     L.circleMarker(e.latlng).addTo(mymap);
            //     mymap.setView(e.latlng, 14);
            // });

            // mymap.on('locationerror', function (e) {
            //     console.log(e);
            //     alert("Location was not found.");

            // });

            // ************* Ethereum functions ***************

 window.userWalletAddress = null;
    const loginButton =  document.getElementById('loginButton');
    const userWallet =  document.getElementById('userWallet');

    function toggleButton(){
        if (!window.ethereum) {
            loginButton.innerText = ' Metamask is not installed'
            loginButton.classList.remove('bg-purple-500', 'text-white')
            loginButton.classList.add('bg-gray-500', 'text-gray-300', 'cursor-not-allowed')
            return false
        }

        loginButton.addEventListener('click', loginWithMetamask)  
    }

    async function loginWithMetamask(){
     const accounts = await  ethereum.request({ method: 'eth_requestAccounts' })
        .catch((e) => {
           console.error(e.message)
           return 
        })
        if(!accounts){
            return
        }
        window.userWalletAddress = accounts[0]
        userWallet.innerText = window.userWalletAddress
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        toggleButton();
    });

    // ++++++++ Paypal Functions
    
     
         function initPayPalButton(){
                paypal.Buttons({
        style: {
          shape: 'rect',
          color: 'gold',
          layout: 'vertical',
          label: 'paypal',
          
        },

        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{"description":"Template","amount":{"currency_code":"USD","value":1}}]
          });
        },

        onApprove: function(data, actions) {
          return actions.order.capture().then(function(orderData) {
            
            // Full available details
            console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));

            // Show a success message within this page, e.g.
            const element = document.getElementById('paypal-button-container');
            element.innerHTML = '';
            element.innerHTML = '<h3>Thank you for your payment!</h3>';

            // Or go to another URL:  actions.redirect('thank_you.html');
            
          });
        },

        onError: function(err) {
          console.log(err);
        }
      }).render('#paypal-button-container');
            };
    

            

            //  ***********  General Functions *********

            function LatLngToArrayString(ll) {
                return "["+ll.lat.toFixed(5)+", "+ll.lng.toFixed(5)+"]";
            }

            function returnLayerByAttribute(lyr,att,val) {
                var arLayers = lyr.getLayers();
                for (i=0;i<arLayers.length-1;i++) {
                    var ftrVal = arLayers[i].feature.properties[att];
                    if (ftrVal==val) {
                        return arLayers[i];
                    }
                }
                return false;
            }

            function testLayerAttribute(ar, val, att, fg, err, btn) {
                if (ar.indexOf(val)<0) {
                    $(fg).addClass("has-error");
                    $(err).html("**** "+att+" NOT FOUND ****");
                    $(btn).attr("disabled", true);
                } else {
                    $(fg).removeClass("has-error");
                    $(err).html("");
                    $(btn).attr("disabled", false);
                }
            };

        </script>
    </body>
</html>
